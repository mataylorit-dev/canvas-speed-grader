<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Account Settings - ClassCrew">
  <title>Settings - ClassCrew</title>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXXXX');
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="./css/design-system.css">
  <link rel="stylesheet" href="./css/main.css">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="./images/favicon.svg">
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" style="background: linear-gradient(180deg, #1e1b4b 0%, #0f172a 100%) !important;">
      <div class="sidebar-header" style="border-bottom-color: rgba(129, 140, 248, 0.2) !important;">
        <a href="dashboard.html" class="navbar-brand" style="color: #ffffff !important;">
          <div class="navbar-brand-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
          </div>
          <span>ClassCrew</span>
        </a>
      </div>

      <nav class="sidebar-nav">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Main</div>
          <a href="dashboard.html" class="sidebar-link sidebar-link-animate">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            Dashboard
          </a>
          <a href="grading.html" class="sidebar-link sidebar-link-animate">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
            Grade Assignments
          </a>
          <a href="roster.html" class="sidebar-link sidebar-link-animate">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Class Roster
          </a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <a href="settings.html" class="sidebar-link active">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            Account
          </a>
          <a href="settings.html#courses" class="sidebar-link sidebar-link-animate">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
            Courses
          </a>
          <a href="settings.html#billing" class="sidebar-link sidebar-link-animate">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            Billing
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="dropdown" id="userDropdown">
          <button class="sidebar-user-btn" onclick="toggleDropdown()">
            <div class="avatar" id="userAvatar">T</div>
            <div class="flex-1 text-left">
              <div class="text-sm font-medium" id="userNameSidebar">Teacher Name</div>
              <div class="text-xs text-muted" id="userEmailSidebar">teacher@school.edu</div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="dropdown-menu">
            <a href="dashboard.html" class="dropdown-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              Dashboard
            </a>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" onclick="signOut()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-with-sidebar page-animate-in">
      <div class="page-header">
        <div class="container">
          <div class="page-header-content">
            <div>
              <h1 class="page-title">Settings</h1>
              <p class="page-description">Manage your account and preferences</p>
            </div>
          </div>
        </div>
      </div>

      <div class="page-content">
        <div class="container">
          <div class="settings-layout">
            <!-- Settings Navigation -->
            <nav class="settings-nav">
              <div class="settings-nav-item active" data-section="account">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                Account
              </div>
              <div class="settings-nav-item" data-section="canvas">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="3" y1="9" x2="21" y2="9"></line>
                  <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
                Canvas Integration
              </div>
              <div class="settings-nav-item" data-section="courses">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                  <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                Courses
              </div>
              <div class="settings-nav-item" data-section="appearance">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="5"></circle>
                  <line x1="12" y1="1" x2="12" y2="3"></line>
                  <line x1="12" y1="21" x2="12" y2="23"></line>
                  <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                  <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                  <line x1="1" y1="12" x2="3" y2="12"></line>
                  <line x1="21" y1="12" x2="23" y2="12"></line>
                  <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                  <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                Appearance
              </div>
              <div class="settings-nav-item" data-section="billing">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                  <line x1="1" y1="10" x2="23" y2="10"></line>
                </svg>
                Billing
              </div>
            </nav>

            <!-- Settings Content -->
            <div class="settings-content">
              <!-- Account Section -->
              <div class="settings-section" id="accountSection">
                <div class="settings-section-header">
                  <h2 class="settings-section-title">Account Information</h2>
                  <p class="settings-section-description">Update your personal details and email</p>
                </div>
                <div class="settings-section-body">
                  <form id="accountForm">
                    <div class="form-group">
                      <label for="displayName" class="form-label">Display Name</label>
                      <input type="text" id="displayName" name="displayName" class="form-input" placeholder="Your name">
                    </div>

                    <div class="form-group">
                      <label for="email" class="form-label">Email Address</label>
                      <input type="email" id="email" name="email" class="form-input" disabled>
                      <p class="form-hint">Email cannot be changed</p>
                    </div>

                    <button type="submit" class="btn btn-primary btn-animate">Save Changes</button>
                  </form>
                </div>
              </div>

              <!-- Canvas Section -->
              <div class="settings-section hidden" id="canvasSection">
                <div class="settings-section-header">
                  <h2 class="settings-section-title">Canvas Integration</h2>
                  <p class="settings-section-description">Manage your Canvas LMS connection</p>
                </div>
                <div class="settings-section-body">
                  <form id="canvasForm">
                    <div class="form-group">
                      <label for="canvasUrl" class="form-label">Canvas URL</label>
                      <input type="url" id="canvasUrl" name="canvasUrl" class="form-input" placeholder="https://yourschool.instructure.com">
                    </div>

                    <div class="form-group">
                      <label for="canvasToken" class="form-label">API Token</label>
                      <input type="password" id="canvasToken" name="canvasToken" class="form-input" placeholder="Enter new token to update">
                      <p class="form-hint">Leave blank to keep existing token</p>
                    </div>

                    <div class="flex gap-3">
                      <button type="button" class="btn btn-secondary btn-animate" onclick="testCanvasConnection()">
                        Test Connection
                      </button>
                      <button type="submit" class="btn btn-primary btn-animate">Save Changes</button>
                    </div>
                  </form>

                  <div id="connectionStatus" class="alert mt-4 hidden"></div>
                </div>
              </div>

              <!-- Courses Section -->
              <div class="settings-section hidden" id="coursesSection">
                <div class="settings-section-header">
                  <h2 class="settings-section-title">Your Courses</h2>
                  <p class="settings-section-description">Manage your enrolled Canvas courses</p>
                </div>
                <div class="settings-section-body">
                  <div id="coursesList" class="space-y-4">
                    <!-- Courses will be loaded here -->
                    <div class="text-center py-8">
                      <div class="spinner mx-auto"></div>
                    </div>
                  </div>

                  <div class="divider"></div>

                  <h3 class="font-semibold mb-4">Add New Course</h3>
                  <form id="addCourseForm" class="flex gap-3">
                    <input type="text" id="newCourseId" name="courseId" class="form-input flex-1" placeholder="Course ID">
                    <button type="submit" class="btn btn-primary btn-animate">Add Course</button>
                  </form>
                </div>
              </div>

              <!-- Appearance Section -->
              <div class="settings-section hidden" id="appearanceSection">
                <div class="settings-section-header">
                  <h2 class="settings-section-title">Appearance</h2>
                  <p class="settings-section-description">Customize the look and feel of the application</p>
                </div>
                <div class="settings-section-body">
                  <div class="form-group">
                    <label class="form-label">Theme</label>
                    <p class="form-hint mb-4">Choose how SpeedGrader looks to you</p>

                    <div class="theme-toggle-group">
                      <button type="button" class="theme-toggle-option" data-theme="light">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="12" cy="12" r="5"></circle>
                          <line x1="12" y1="1" x2="12" y2="3"></line>
                          <line x1="12" y1="21" x2="12" y2="23"></line>
                          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                          <line x1="1" y1="12" x2="3" y2="12"></line>
                          <line x1="21" y1="12" x2="23" y2="12"></line>
                          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <span>Light</span>
                      </button>
                      <button type="button" class="theme-toggle-option" data-theme="dark">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <span>Dark</span>
                      </button>
                      <button type="button" class="theme-toggle-option" data-theme="system">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                          <line x1="8" y1="21" x2="16" y2="21"></line>
                          <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        <span>System</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Billing Section -->
              <div class="settings-section hidden" id="billingSection">
                <div class="settings-section-header">
                  <h2 class="settings-section-title">Billing & Subscription</h2>
                  <p class="settings-section-description">Manage your subscription and payment methods</p>
                </div>
                <div class="settings-section-body">
                  <!-- Current Subscription Status -->
                  <div id="subscriptionStatus" class="card mb-6">
                    <div class="card-body">
                      <div class="flex items-center justify-between">
                        <div>
                          <h3 class="font-semibold text-lg" id="currentPlanName">Free Trial</h3>
                          <p class="text-muted text-sm" id="currentPlanDetails">No active subscription</p>
                        </div>
                        <span class="badge" id="subscriptionBadge">Inactive</span>
                      </div>
                      <div id="subscriptionInfo" class="mt-4 hidden">
                        <div class="flex justify-between text-sm mb-2">
                          <span class="text-muted">Classes included:</span>
                          <span class="font-medium" id="classesIncluded">0</span>
                        </div>
                        <div class="flex justify-between text-sm mb-2">
                          <span class="text-muted">Next billing date:</span>
                          <span class="font-medium" id="nextBillingDate">--</span>
                        </div>
                        <div class="flex justify-between text-sm">
                          <span class="text-muted">Amount:</span>
                          <span class="font-medium" id="billingAmount">--</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Available Plans -->
                  <h3 class="font-semibold mb-4">Choose a Plan</h3>
                  <div class="billing-plans-grid">
                    <!-- Monthly Plan -->
                    <div class="billing-plan-card" data-plan="monthly">
                      <div class="billing-plan-header">
                        <h4 class="billing-plan-name">Monthly</h4>
                        <div class="billing-plan-price">
                          <span class="billing-plan-amount">$9.99</span>
                          <span class="billing-plan-period">/month per class</span>
                        </div>
                      </div>
                      <ul class="billing-plan-features">
                        <li>1 Canvas course</li>
                        <li>Unlimited assignments</li>
                        <li>Cancel anytime</li>
                      </ul>
                      <button class="btn btn-secondary w-full" onclick="subscribeToPlan('monthly')">
                        Subscribe Monthly
                      </button>
                    </div>

                    <!-- Yearly Plan -->
                    <div class="billing-plan-card featured" data-plan="yearly">
                      <div class="billing-plan-badge">Best Value</div>
                      <div class="billing-plan-header">
                        <h4 class="billing-plan-name">Yearly Bundle</h4>
                        <div class="billing-plan-price">
                          <span class="billing-plan-amount">$199</span>
                          <span class="billing-plan-period">/year</span>
                        </div>
                      </div>
                      <ul class="billing-plan-features">
                        <li><strong>3 classes included</strong></li>
                        <li>+$49/year per additional class</li>
                        <li>Save $160/year vs monthly</li>
                        <li>Priority support</li>
                      </ul>
                      <button class="btn btn-primary w-full" onclick="subscribeToPlan('yearly')">
                        Subscribe Yearly
                      </button>
                    </div>
                  </div>

                  <!-- Add Extra Classes (for yearly plan) -->
                  <div id="addClassesSection" class="mt-6 hidden">
                    <div class="divider"></div>
                    <h3 class="font-semibold mb-4">Add Extra Classes</h3>
                    <p class="text-muted text-sm mb-4">Add more classes to your yearly subscription for $49/year each.</p>
                    <div class="flex gap-3 items-center">
                      <select id="extraClassesSelect" class="form-input" style="width: auto;">
                        <option value="1">1 extra class (+$49/year)</option>
                        <option value="2">2 extra classes (+$98/year)</option>
                        <option value="3">3 extra classes (+$147/year)</option>
                        <option value="4">4 extra classes (+$196/year)</option>
                        <option value="5">5 extra classes (+$245/year)</option>
                      </select>
                      <button class="btn btn-secondary" onclick="addExtraClasses()">Add Classes</button>
                    </div>
                  </div>

                  <!-- Cancel Subscription -->
                  <div id="cancelSection" class="mt-6 hidden">
                    <div class="divider"></div>
                    <h3 class="font-semibold mb-4">Cancel Subscription</h3>
                    <p class="text-muted text-sm mb-4">Your subscription will remain active until the end of the current billing period.</p>
                    <button class="btn btn-outline-error" onclick="cancelSubscription()">Cancel Subscription</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- App Scripts -->
  <script src="./js/firebase-config.js"></script>
  <script src="./js/theme.js"></script>
  <script src="./js/auth.js"></script>
  <script src="./js/api.js"></script>
  <script src="./js/app.js"></script>

  <script>
    let userData = null;

    // Check authentication
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // Update user info in sidebar
      document.getElementById('userNameSidebar').textContent = user.displayName || 'Teacher';
      document.getElementById('userEmailSidebar').textContent = user.email;
      document.getElementById('userAvatar').textContent = (user.displayName || user.email)[0].toUpperCase();

      // Load user data
      userData = await Auth.getUserData();
      populateSettings();
    });

    // Toggle user dropdown
    function toggleDropdown() {
      document.getElementById('userDropdown').classList.toggle('open');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('userDropdown');
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
      }
    });

    // Populate settings forms
    function populateSettings() {
      if (!userData) return;

      document.getElementById('displayName').value = userData.display_name || '';
      document.getElementById('email').value = userData.email || '';
      document.getElementById('canvasUrl').value = userData.canvas_url || '';

      loadCourses();
    }

    // Load courses
    function loadCourses() {
      const container = document.getElementById('coursesList');
      const courses = userData?.courses || [];

      if (courses.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: var(--space-8); text-align: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 16px; opacity: 0.5;">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
            <p class="text-muted" style="margin-bottom: 16px;">No courses found</p>
            <p class="text-muted text-sm" style="margin-bottom: 16px;">Configure your Canvas credentials to auto-import your courses</p>
            <button class="btn btn-secondary btn-sm" onclick="refreshCourses()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Refresh from Canvas
            </button>
          </div>
        `;
        return;
      }

      container.innerHTML = courses.map(course => `
        <div class="course-card ${course.id === userData.course_id ? 'active' : ''}">
          <div class="course-card-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
          </div>
          <div class="course-card-content">
            <div class="course-card-name">${course.name || 'Course ' + course.id}</div>
            <div class="course-card-id">${course.code ? course.code + ' - ' : ''}ID: ${course.id}</div>
          </div>
          ${course.id !== userData.course_id ? `
            <button class="btn btn-sm btn-ghost" onclick="setActiveCourse('${course.id}')">
              Activate
            </button>
          ` : `
            <span class="badge badge-success">Active</span>
          `}
        </div>
      `).join('');
    }

    // Settings navigation
    document.querySelectorAll('.settings-nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const section = item.dataset.section;

        // Update nav active state
        document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        // Show correct section
        document.querySelectorAll('.settings-section').forEach(s => s.classList.add('hidden'));
        document.getElementById(`${section}Section`).classList.remove('hidden');
      });
    });

    // Account form
    document.getElementById('accountForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const displayName = document.getElementById('displayName').value;

      try {
        await Auth.updateProfile({ display_name: displayName });
        showToast('Account updated successfully', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    });

    // Canvas form - save and validate credentials, then fetch courses
    document.getElementById('canvasForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const canvasUrl = document.getElementById('canvasUrl').value;
      const canvasToken = document.getElementById('canvasToken').value;
      const statusEl = document.getElementById('connectionStatus');

      if (!canvasUrl) {
        showToast('Please enter Canvas URL', 'error');
        return;
      }

      // If token provided, validate and save with courses
      if (canvasToken) {
        statusEl.className = 'alert alert-info mt-4';
        statusEl.textContent = 'Validating credentials and fetching courses...';
        statusEl.classList.remove('hidden');

        try {
          // Validate and save credentials, which also fetches courses
          const result = await API.validateCanvasCredentials(canvasUrl, canvasToken, true);

          if (result.valid) {
            statusEl.className = 'alert alert-success mt-4';
            statusEl.textContent = `Connected! Found ${result.courses?.length || 0} courses.`;

            // Reload user data to get updated courses
            userData = await Auth.getUserData();
            loadCourses();

            // Clear token field
            document.getElementById('canvasToken').value = '';
            showToast('Canvas settings saved successfully', 'success');
          } else {
            statusEl.className = 'alert alert-error mt-4';
            statusEl.textContent = 'Connection failed. Please check your credentials.';
          }
        } catch (error) {
          statusEl.className = 'alert alert-error mt-4';
          statusEl.textContent = error.message;
          showToast(error.message, 'error');
        }
      } else {
        // Just update URL without token
        try {
          await Auth.updateProfile({ canvas_url: canvasUrl });
          showToast('Canvas URL updated', 'success');
        } catch (error) {
          showToast(error.message, 'error');
        }
      }
    });

    // Test Canvas connection (without saving)
    async function testCanvasConnection() {
      const canvasUrl = document.getElementById('canvasUrl').value;
      const canvasToken = document.getElementById('canvasToken').value || userData?.canvas_token;
      const statusEl = document.getElementById('connectionStatus');

      if (!canvasUrl || !canvasToken) {
        statusEl.className = 'alert alert-warning mt-4';
        statusEl.textContent = 'Please enter Canvas URL and token';
        statusEl.classList.remove('hidden');
        return;
      }

      statusEl.className = 'alert alert-info mt-4';
      statusEl.textContent = 'Testing connection...';
      statusEl.classList.remove('hidden');

      try {
        const result = await API.validateCanvasCredentials(canvasUrl, canvasToken, false);
        if (result.valid) {
          statusEl.className = 'alert alert-success mt-4';
          statusEl.innerHTML = `
            <strong>Connection successful!</strong><br>
            Found ${result.courses?.length || 0} courses. Click "Save Changes" to save credentials and import courses.
          `;
        } else {
          statusEl.className = 'alert alert-error mt-4';
          statusEl.textContent = 'Connection failed. Please check your credentials.';
        }
      } catch (error) {
        statusEl.className = 'alert alert-error mt-4';
        statusEl.textContent = error.message;
      }
    }

    // Refresh courses from Canvas
    async function refreshCourses() {
      try {
        showToast('Fetching courses from Canvas...', 'info');
        const result = await API.getCanvasCourses();
        userData = await Auth.getUserData();
        loadCourses();
        showToast(`Found ${result.courses?.length || 0} courses`, 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Add course form
    document.getElementById('addCourseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const courseId = document.getElementById('newCourseId').value;

      if (!courseId) {
        showToast('Please enter a course ID', 'error');
        return;
      }

      try {
        await Auth.addCourse({
          courseId,
          canvasUrl: userData.canvas_url
        });
        userData = await Auth.getUserData();
        loadCourses();
        document.getElementById('newCourseId').value = '';
        showToast('Course added successfully', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    });

    // Set active course
    async function setActiveCourse(courseId) {
      try {
        await Auth.setActiveCourse(courseId);
        userData = await Auth.getUserData();
        loadCourses();
        showToast('Active course updated', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Sign out
    async function signOut() {
      await firebase.auth().signOut();
      window.location.href = 'login.html';
    }

    // Toast helper
    function showToast(message, type = 'info') {
      App.showToast(message, type);
    }

    // Initialize theme toggle buttons after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      Theme.bindToggleButtons();
      Theme.updateToggleUI(Theme.get());
    });

    // =========================================================================
    // Billing Functions
    // =========================================================================

    // Load subscription status
    async function loadSubscription() {
      try {
        const subscription = await API.getSubscription();
        updateSubscriptionUI(subscription);
      } catch (error) {
        console.error('Failed to load subscription:', error);
      }
    }

    // Update subscription UI based on status
    function updateSubscriptionUI(subscription) {
      const planName = document.getElementById('currentPlanName');
      const planDetails = document.getElementById('currentPlanDetails');
      const badge = document.getElementById('subscriptionBadge');
      const subscriptionInfo = document.getElementById('subscriptionInfo');
      const addClassesSection = document.getElementById('addClassesSection');
      const cancelSection = document.getElementById('cancelSection');

      if (subscription && subscription.status === 'active') {
        // Active subscription
        const isYearly = subscription.plan === 'yearly';
        planName.textContent = isYearly ? 'Yearly Bundle' : 'Monthly Plan';
        planDetails.textContent = isYearly
          ? `${subscription.classes_included || 3} classes included`
          : '1 class included';

        badge.textContent = 'Active';
        badge.className = 'badge badge-success';

        // Show subscription details
        subscriptionInfo.classList.remove('hidden');
        document.getElementById('classesIncluded').textContent = subscription.classes_included || (isYearly ? 3 : 1);
        document.getElementById('nextBillingDate').textContent = subscription.next_billing_date
          ? new Date(subscription.next_billing_date).toLocaleDateString()
          : '--';
        document.getElementById('billingAmount').textContent = subscription.amount
          ? `$${(subscription.amount / 100).toFixed(2)}`
          : (isYearly ? '$199.00' : '$9.99');

        // Show add classes option for yearly
        if (isYearly) {
          addClassesSection.classList.remove('hidden');
        } else {
          addClassesSection.classList.add('hidden');
        }

        // Show cancel option
        cancelSection.classList.remove('hidden');
      } else {
        // No active subscription
        planName.textContent = 'No Active Plan';
        planDetails.textContent = 'Subscribe to start grading';
        badge.textContent = 'Inactive';
        badge.className = 'badge badge-secondary';
        subscriptionInfo.classList.add('hidden');
        addClassesSection.classList.add('hidden');
        cancelSection.classList.add('hidden');
      }
    }

    // Subscribe to a plan
    async function subscribeToPlan(planType) {
      try {
        showToast('Redirecting to checkout...', 'info');

        // Create checkout session
        const priceId = planType === 'yearly' ? 'price_yearly_199' : 'price_monthly_999';
        const result = await API.createCheckoutSession(priceId);

        if (result.checkoutUrl) {
          // Redirect to Stripe Checkout
          window.location.href = result.checkoutUrl;
        } else {
          throw new Error('Failed to create checkout session');
        }
      } catch (error) {
        showToast('Failed to start checkout: ' + error.message, 'error');
      }
    }

    // Add extra classes to yearly subscription
    async function addExtraClasses() {
      const count = document.getElementById('extraClassesSelect').value;
      try {
        showToast('Redirecting to checkout...', 'info');

        // Create checkout session for extra classes
        const result = await API.createCheckoutSession('price_extra_class_49', { quantity: parseInt(count) });

        if (result.checkoutUrl) {
          window.location.href = result.checkoutUrl;
        } else {
          throw new Error('Failed to create checkout session');
        }
      } catch (error) {
        showToast('Failed to add classes: ' + error.message, 'error');
      }
    }

    // Cancel subscription
    async function cancelSubscription() {
      if (!confirm('Are you sure you want to cancel your subscription? You will retain access until the end of your billing period.')) {
        return;
      }

      try {
        await API.cancelSubscription();
        showToast('Subscription cancelled. You will retain access until the end of your billing period.', 'success');
        loadSubscription();
      } catch (error) {
        showToast('Failed to cancel subscription: ' + error.message, 'error');
      }
    }

    // Load subscription on page load
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        loadSubscription();
      }
    });

    // Handle URL hash for direct navigation to billing
    if (window.location.hash === '#billing') {
      document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
      document.querySelector('[data-section="billing"]').classList.add('active');
      document.querySelectorAll('.settings-section').forEach(s => s.classList.add('hidden'));
      document.getElementById('billingSection').classList.remove('hidden');
    }
  </script>
</body>
</html>
